<#
.SYNOPSIS
    Compares the configuration of two SQL Server instances

.DESCRIPTION
    You can pass in two instance names, or just one. If you only enter one, then the script will look for an AlwaysOn replica and use that.
    It there are multiple replicas, then a popup will be displayed, allowing you to choose.
    
.NOTES
    Additional Notes, eg
    File Name    : compare_instance.ps1
    Author       : Howard Dunn
    Date Written : 
    ========================================================================
    Change Log

    Howard Dunn - 12th November 2018
        . Added default mail profile check
        . Added public mail profile check
        . Updated to use the latest DBATools version
        . Fixed the display of remote user for linked server
        . Added the account of the user running the report to the report
    ========================================================================

.EXAMPLE
    Compare two instances. 
        No testing of linked server connectivity
        Showing missing DB's
        Not comparing database roles
    .\compare_instance.ps1 -source beddevsql001-h -target beddevsql002-h
    
.EXAMPLE
    Compare two instances. 
        Test linked server connectivity
        Showing missing DB's
        Not comparing database roles
    .\compare_instance.ps1 -source beddevsql001-h -target beddevsql002-h -test_linked_server = 1

#>

param
(
    [string]$source,
    [string]$target, #'marsqlprd21a',
    [int]$test_linked_server = 0,
    [int]$show_missing_databases = 0,
    [int]$compare_user_database_roles = 0
    #[string]$output_path = 'c:\temp'
)

Clear


if (!(Get-Module -ListAvailable -Name dbatools))
 {
    Write-Host "You need to install dbatools" -ForegroundColor Red
    exit
} 
else 
{
    Write-Host "" -ForegroundColor Green
}
write-host ""


###########################################
#region <<<<<<<<<< Functions >>>>>>>>>>
###########################################


FUNCTION dba_GetReplica
(
    $cmp_source
)

{


$target_replicas = (Get-DbaAgReplica -SqlInstance $cmp_source | where {$_.replica -ne $cmp_source}).replica | sort -Unique

if ($target_replicas -eq $null)
{
    write-host "This instance has no replicas"
    exit

}
if ($target_replicas.count -gt 1)
{

# Create the Windows Form

$form = New-Object Windows.Forms.Form 
$form.FormBorderStyle = "FixedToolWindow" 
$form.Text = "Multiple Replicas Exist" 
$form.StartPosition = "CenterScreen" 
$form.Width = 300 ; $form.Height = 220 

# Create the button panel 
$buttonPanel = New-Object Windows.Forms.Panel  
$buttonPanel.Size = New-Object Drawing.Size @(400,40) 
$buttonPanel.Dock = "Bottom"

# Create the cancel button   
$cancelButton = New-Object Windows.Forms.Button  
$cancelButton.Top = $buttonPanel.Height - $cancelButton.Height - 10; $cancelButton.Left = $buttonPanel.Width - $cancelButton.Width - 10 
$cancelButton.Text = "Cancel" 
$cancelButton.DialogResult = "Cancel" 
$cancelButton.Anchor = "Right"

# Create the OK buton 
$okButton = New-Object Windows.Forms.Button   
$okButton.Top = $cancelButton.Top ; $okButton.Left = $cancelButton.Left - $okButton.Width - 5 
$okButton.Text = "Ok" 
$okButton.DialogResult = "Ok" 
$okButton.Anchor = "Right" 

# Add the buttons
$buttonPanel.Controls.Add($okButton) 
$buttonPanel.Controls.Add($cancelButton) 
$form.Controls.Add($buttonPanel) 

$form.AcceptButton = $okButton          # ENTER = Ok 
$form.CancelButton = $cancelButton      # ESCAPE = Cancel 
 
# Display the top message

$txtMess = New-Object System.Windows.Forms.Label; 
    $txtMess.Text = "Please choose a replica to compare with"; $txtMess.Top = 10; $txtMess.Left = 5; $txtMess.Autosize = $true  
$form.Controls.Add($txtMess)

# Display the Source
$lblHost = New-Object System.Windows.Forms.Label   
$lblHost.Text = "Source Instance:"  
$lblHost.Top = 40 ; $lblHost.Left = 5; $lblHost.Width=150 ;$lblHost.AutoSize = $true 
$form.Controls.Add($lblHost)
    
$txtHost = New-Object Windows.Forms.TextBox  
$txtHost.TabIndex = 0 # set Tab Order 
$txthost.ReadOnly = 1
$txtHost.Top = 40; $txtHost.Left = 120; $txtHost.Width = 150;  
$txtHost.Text = $cmp_source   
$form.Controls.Add($txtHost)

     
# Create the combo box 
$lblImage = New-Object System.Windows.Forms.Label; $lblImage.Text = "Always On Replica:"; $lblImage.Top = 90; $lblImage.Left = 5; $lblImage.Autosize = $true  
$form.Controls.Add($lblImage)

$cbImage1 = New-Object Windows.Forms.ComboBox ; $cbImage1.Top = 90; $cbImage1.Left = 120; $cbImage1.Width = 150 

$ArrayImage = $target_replicas  # Populate the array with Replicas 
[void] $cbImage1.BeginUpdate() # Don't update the display yet

foreach ($element in $ArrayImage) {  
    $thisElement = $element 
    [void] $cbImage1.Items.Add($thisElement) 
    } 
$cbImage1.SelectedIndex = $iSelect  # Set the default SelectedIndex 
[void] $cbImage1.EndUpdate()  # update the control with all the data that was added 
$form.Controls.Add($cbImage1) 
 
# Display The Form

$form.Add_Shown( { $form.Activate(); $okButton.Focus() } )
$result = $form.ShowDialog()
 
# Grab the results

if($result -eq "OK") 
    {   # Copy variables and use them as you desire... 
    $locListBox.SelectedItem 
    $replica =  $cbImage1.SelectedItem 
    $replica
} 
else {Write-Host "Cancel"} 
Return
}
else
{
    write-host "Replica found - $target_replicas" -ForegroundColor Yellow
    $target_replicas

}
write-host ""
}

#endregion 


Add-Type -Assembly System.Windows.Forms

$compare_date = Get-Date
$RunTime = get-date -Format "yyyy-MM-dd_hh.mm.ss.ms"

$source = $source.ToUpper()

try
{
    $ss = Connect-DbaInstance $source
}
catch
{
    write-host "Can't connect to source server.!" -foregroundColor Red
    return

}

if (!($target))
{
    write-host "No Target entered. Grabbing a list of replicas" -ForegroundColor Yellow
    [string]$target = dba_GetReplica -cmp_source $source
}

$target = ($target.ToUpper()).Trim()

try
{
    $ts = Connect-DbaInstance -sqlinstance "$target"
}
catch
{5
    write-host "Can't connect to target server.!" -foregroundColor Red
    return

}

$thisScript = $myInvocation.MyCommand.Path; $scriptRoot = Split-Path(Resolve-Path $thisScript);
$filename = ("$source.Vs.$Target.$runtime.html").Replace("\", "-")
#$output_file = $scriptroot + "\Reports\" + "$source.Vs.$Target.$runtime.html"
$output_file = $scriptroot + "\Reports\" + $filename
#$output_file = $output_file.Replace("\", "-")
$ran_by = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name

$sql_startup = 
@"
SELECT
    DSR.registry_key as [key],
    DSR.value_name as Name,
    DSR.value_data as Data 
FROM sys.dm_server_registry AS DSR 
WHERE 
    DSR.registry_key LIKE N'%MSSQLServer\Parameters'
    AND left(cast(value_data as varchar(max)), 2) not in ('-d','-e','-l')
"@

write-host "------------------------------------------------------------" -ForegroundColor Green
Write-Host "  Source Server :  $source" -ForegroundColor Green
Write-Host "  Target Server :  $target" -ForegroundColor Green
write-host "------------------------------------------------------------" -ForegroundColor Green
write-host

###################################################
#region <<<<<<<<<< Get build details >>>>>>>>>>
###################################################

    write-host "Processing Build Details..." -ForegroundColor Yellow -NoNewline
    $s_b = Get-DbaBuildReference -SqlInstance $source
    $s_instance = $s_b.SqlInstance
    $s_build = $s_b.Build

    $t_b = Get-DbaBuildReference  -SqlInstance $target
    $t_instance = $t_b.SqlInstance
    $t_build = $t_b.Build

    $s_s = Get-DbaComputerSystem $source
    $s_pprocs = $s_s.NumberProcessors
    $s_lprocs = $s_s.NumberLogicalProcessors
    $s_ram = $s_s.TotalPhysicalMemory

    $t_s = Get-DbaComputerSystem $target
    $t_pprocs = $t_s.NumberProcessors
    $t_lprocs = $t_s.NumberLogicalProcessors
    $t_ram = $t_s.TotalPhysicalMemory
    write-host "Done!" -ForegroundColor Green

#endregion 

########################################################
#region <<<<<<<<<< Get Startup Parameters >>>>>>>>>>
########################################################

    write-host "Processing Startup Parameters..." -ForegroundColor Yellow -NoNewline
    $su_s = $ss.ConnectionContext.ExecuteReader($sql_startup)
    if (!($su_s))
    {
    $su_s = New-Object system.object
    $su_s | Add-Member -type NoteProperty -name "Key" -value  'None'
    $su_s | Add-Member -type NoteProperty -name "Name" -value  'None'
    $su_s | Add-Member -type NoteProperty -name "Data" -value  'None'
    }

    $su_t = $ts.ConnectionContext.ExecuteReader($sql_startup)
    if (!($su_t))
    {
    $su_t = New-Object system.object
    $su_t | Add-Member -type NoteProperty -name "Key" -value  'None'
    $su_t | Add-Member -type NoteProperty -name "Name" -value  'None'
    $su_t | Add-Member -type NoteProperty -name "Data" -value  'None'
    }

    $missing_su = Compare-Object $su_s $su_t -Property key, name, data

    if ($missing_su)
    {
        $frag_su =  $missing_su | select key, name, data `
        |  where {$_.key -ne 'None'} | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=Green size=4>Mismatched Startup Parameters</font></b><br><br>" | Out-String

    }
    write-host "Done!" -ForegroundColor Green

#endregion

###############################################
#region <<<<<<<<<< Mail Profiles >>>>>>>>>>
###############################################

$sql_mp = 
"
SELECT 
	sp.name as name, 
	CASE
		WHEN pp.is_default IS NULL THEN 'False'
		ELSE 'True'
	END AS is_public,
	ISNULL(pp.is_default, 'False') as is_default
FROM  msdb.dbo.sysmail_profile AS sp
LEFT JOIN msdb.dbo.sysmail_principalprofile AS pp ON
	pp.profile_id = sp.profile_id
"

$mp_s = Invoke-DbaQuery -SqlInstance $source -query $sql_mp 
$mp_t = Invoke-DbaQuery -SqlInstance $target -query $sql_mp 


    write-host "Processing Mail Profiles..." -ForegroundColor Yellow -NoNewline
    #$mp_s = $ss.mail.profiles | select name, is_default
    if (!($mp_s))
    {
    $mp_s = New-Object system.object
    $mp_s | Add-Member -type NoteProperty -name "name" -value  'None'
    $mp_s | Add-Member -type NoteProperty -name "is_public" -value  'None'
    $mp_s | Add-Member -type NoteProperty -name "is_default" -value  'No'
    }

    #$mp_t = $ts.mail.profiles | select name
    if (!($mp_t))
    {
    $mp_t = New-Object system.object
    $mp_t | Add-Member -type NoteProperty -name "name" -value  'None'
    $mp_t | Add-Member -type NoteProperty -name "is_public" -value  'None'
    $mp_t | Add-Member -type NoteProperty -name "is_default" -value  'No'
    }

    $missing_mp = Compare-Object $mp_s $mp_t -Property name, is_public, is_default

    if ($missing_mp)
    {
        $frag_mp =  $missing_mp | select name, is_public, is_default,  @{n="Incorrect / Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
        |  ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=Green size=4>Missing / Mismatched Mail Profiles</font></b><br><br>" | Out-String

    }
    write-host "Done!" -ForegroundColor Green


#endregion

###################################################
#region <<<<<<<<<< Get Tempdb Config >>>>>>>>>>
###################################################

$pre_tdb_differences = @"
<br><b><font color=green size=4>TempDB file differences</font></b><br>
<font color=#2B3856 size=3>&nbsp;&nbsp;&nbsp;Files that exist on both instances, but are different</font><br><br>
"@

    write-host "Processing TempDB Configuration..." -ForegroundColor Yellow -NoNewline


    $tdb_diff = "<br><strong><font color = green size = 4>TempDB file differences</font></strong><br><br>"
    $tdb_ds = "<br><strong><font color = green  size = 4>TempDB files missing on target</font></strong><br><br>"
    $tdb_dt = "<br><strong><font color = green  size = 4>TempDB files missing on source</font></strong><br><br>"

    $tempdb_s = Get-DbaDBFile -SqlInstance $source -Database tempdb | select logicalname, maxsize, growth, growthtype, size 
    $tempdb_t = Get-DbaDBFile -SqlInstance $target -Database tempdb | select logicalname, maxsize, growth, growthtype, size 


    $tempdb_differences = foreach ($file in $tempdb_s) 
    {
        $prunning = $file.RunningValue
        [pscustomobject]@{
            logicalname = $file.logicalname
            s_maxsize = $file.maxsize
            s_growth = $file.growth
            s_growthtype = $file.growthtype
      #      s_size = $file.size
            t_maxsize = ($tempdb_t | Where {$_.logicalname -eq $file.logicalname }).maxsize
            t_growth = ($tempdb_t | Where {$_.logicalname -eq $file.logicalname }).growth
            t_growthtype = ($tempdb_t | Where {$_.logicalname -eq $file.logicalname }).growthtype
       #     t_size = ($tempdb_t | Where {$_.logicalname -eq $file.logicalname }).size
        }
    }

    $b = $tempdb_differences | select logicalname, s_maxsize, s_growth, s_growthtype, t_maxsize, t_growth, t_growthtype |`
    where {$_.s_maxsize -ne $_.t_maxsize -or $_.s_growth -ne $_.t_growth -or $_.s_growthtype -ne $_.t_growthtype}

    $a = $b | where {$_.s_maxsize -ne $null -and $_.t_maxsize -ne $null  -and $_.s_growth -ne $null -and $_.t_growth -ne $null -and $_.s_growthtype -ne $null -and $_.t_growthtype -ne $null} `
    | select logicalname, @{n='Source MaxSize';expression={$_.s_maxsize}}, `
     @{n='Source Growth';expression={$_.s_growth}}, `
     @{n='Source Growth Type';expression={$_.s_growthtype}}, `
     @{n='Target MaxSize';expression={$_.t_maxsize}}, `
     @{n='Target Growth';expression={$_.t_growth}}, `
     @{n='Target Growth Type';expression={$_.t_growthtype}}
   

    $TempDBOnSource = $tempdb_s | where {$_.logicalname -notin $tempdb_t.logicalname}
    $TempDBOnTarget = $tempdb_t | where {$_.logicalname -notin $tempdb_s.logicalname}

    if ($a)
    {
        $frag_tempdb =  $a |  ConvertTo-Html -as Table -PreContent $pre_tdb_differences | Out-String
        $frag_tempdb = $frag_tempdb -replace("<th>logicalname</th>", "<th>Logical Name</th>")
        $frag_tempdb = $frag_tempdb -replace("<th>Target MaxSize</th>", "<th style='background-color:mistyrose'>Target MaxSize</th>")
        $frag_tempdb = $frag_tempdb -replace("<th>Target Growth</th>", "<th style='background-color:mistyrose'>Target Growth</th>")
        $frag_tempdb = $frag_tempdb -replace("<th>Target Growth Type</th>", "<th style='background-color:mistyrose'>Target Growth Type</th>")
        $frag_tempdb = $frag_tempdb -replace("<th>Source MaxSize</th>", "<th style='background-color:honeydew'>Source MaxSize</th>")
        $frag_tempdb = $frag_tempdb -replace("<th>Source Growth</th>", "<th style='background-color:honeydew'>Source Growth</th>")
        $frag_tempdb = $frag_tempdb -replace("<th>Source Growth Type</th>", "<th style='background-color:honeydew'>Source Growth Type</th>")
    }
    
    if ($TempDBOnSource)
    {
        $frag_tempdb_s =  $TempDBOnSource | select logicalname, maxsize, growth, growthtype,size `
        |  ConvertTo-Html -as Table -PreContent $tdb_ds | Out-String
    }

    if ($TempDBOnTarget)
    {
        $frag_tempdb_t =  $TempDBOnTarget | select logicalname, maxsize, growth, growthtype,size `
        |  ConvertTo-Html -as Table -PreContent $tdb_dt | Out-String
    }
    write-host "Done!" -ForegroundColor Green

#endregion

#############################################################
#region <<<<<<<<<< Get Instance Configurations >>>>>>>>>>
#############################################################

    write-host "Processing Instance Configuration..." -ForegroundColor Yellow -NoNewline
    $source_props = Get-DbaSpConfigure -SqlInstance $source
    $target_props = Get-DbaSpConfigure -SqlInstance $target
 
    $propcompare = foreach ($prop in $source_props) 
    {
        $prunning = $prop.RunningValue
        [pscustomobject]@{
            Config = $prop.DisplayName
            'Source' = $prop.RunningValue
            'Target' = ($target_props | Where {$_.ConfigName -eq $prop.ConfigName }).RunningValue
        }
    }

    $prop_diff = $propcompare | where {$_.source -ne $_.target}

    
    if ($prop_diff)
    {
        $frag_config = $prop_diff | select Config, Source, Target `
        |  ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=Green size=4>Instance Configuration</font></b><br><br>" | out-string

    }

    $s_mdop = ($source_props | where {$_.displayname -eq 'max degree of parallelism'}).runningvalue
    $t_mdop = ($target_props | where {$_.displayname -eq 'max degree of parallelism'}).runningvalue

    $s_cdop = ($source_props | where {$_.displayname -eq 'cost threshold for parallelism'}).runningvalue
    $t_cdop = ($target_props | where {$_.displayname -eq 'cost threshold for parallelism'}).runningvalue
    write-host "Done!" -ForegroundColor Green

#endregion


###############################################
#region <<<<<<<<<< Get Databases >>>>>>>>>>
###############################################

write-host "Processing Databases..." -ForegroundColor yellow -NoNewline

$pre_dbs = @"
<br><b><font color=green size=4>Missing Databases</font></b><br>
<font color=#2B3856 size=3>&nbsp;&nbsp;&nbsp;Found on one instance, but not the other</font><br><br>
"@


$source_databases = Get-DbaDatabase $source
$target_databases = Get-DbaDatabase $target

if ($show_missing_databases -eq 1)
{
    $unmatched_databases = Compare-Object $source_databases $target_databases -Property name
    if ($unmatched_databases)
    {
        $frag_udbs =   $unmatched_databases | select name, @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
        |  ConvertTo-Html -as Table -Fragment -PreContent $pre_dbs | Out-String

    }
}
write-host "Done!" -ForegroundColor Green

#endregion


################################################
#region <<<<<<<<<< Missing Logins >>>>>>>>>>
################################################
    
    write-host "Processing Logins..." -ForegroundColor Yellow -NoNewline
    $sourcelogins = get-dbalogin $source
    $targetlogins = get-dbalogin $target

    $missing_logins = Compare-Object $sourcelogins $targetlogins -Property name, logintype
    
    if ($missing_logins)
    {
        $frag_logins =   $missing_logins | select name, logintype, @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
        |  ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Missing Logins</font></b><br><br>" | Out-String

    }
    write-host "Done!" -ForegroundColor Green
#endregion


###########################################
#region <<<<<<<<<< Disk Capacity >>>>>>>>>>
###########################################

write-host "Processing Disk Capacity..." -ForegroundColor yellow -NoNewline

$CapacityGB = @{Name="Capacity";expression={[math]::round(($_.Capacity/ 1073741824),2)}}
$FreeGB = @{Name="FreeSpace";expression={[math]::round(($_.FreeSpace / 1073741824),2)}}
$FreePCT = @{Name="Free(%)";expression={[math]::round(((($_.FreeSpace / 1073741824)/($_.Capacity / 1073741824)) * 100),0)}}

$volumes = Get-WmiObject -computer $source win32_volume 
$sourcevolumes = $volumes | where {$_.name -notlike "*?\Volume*"} |select  name,$CapacityGB, $FreePCT,$freegb

$volumes = Get-WmiObject -computer $target win32_volume 
$targetvolumes = $volumes | where {$_.name -notlike "*?\Volume*"} |select  name,$CapacityGB, $FreePCT,$freegb

$incorrectvolumes = Compare-Object $sourcevolumes $targetvolumes -Property name, capacity -PassThru | select name, capacity, sideindicator | Sort-Object name


if ($incorrectvolumes)
{
    $frag_volumes =   $incorrectvolumes | select name, capacity, @{n="Capacity On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
    |  ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Mismatched Disk Capacity</font></b><br><br>" | Out-String

}
write-host "Done!" -ForegroundColor Green


#######################################################
#region <<<<<<<<<< Database Role Members >>>>>>>>>>
#######################################################

write-host "Processing Role Members..." -ForegroundColor yellow -NoNewline


$matched_databases = Compare-Object $source_databases $target_databases -Property name -ExcludeDifferent -IncludeEqual

if ($compare_user_database_roles -eq 1)
{

    $pre_rm = 
    "<br><b><font color=green size=4>Database Roles</font></b><br>
    <font color=#2B3856 size=3>&nbsp;&nbsp;&nbsp Database Roles which are either missing on either instance, or have mismatched members</font><br><br>"
 
    $source_db_role_members = GET-DbaDBRolemember -SqlInstance $source -Database $matched_databases.name 
    $target_db_role_members = GET-DbaDBRolemember -SqlInstance $target  -Database $matched_databases.name 
}
else
{

    $pre_rm = 
    "<br><b><font color=green size=4>Database Roles (System Databases Only)</font></b><br>
    <font color=#2B3856 size=3>&nbsp;&nbsp;&nbsp Database Roles which are either missing on either instance, or have mismatched members</font><br><br>"
    
    $source_db_role_members = GET-DbaDBRolemember -SqlInstance $source -Database master, model, msdb
    $target_db_role_members = GET-DbaDBRolemember -SqlInstance $target  -Database master, model, msdb
}

$mismatched_db_roles = Compare-Object $source_db_role_members $target_db_role_members -Property database, role, username

if ($mismatched_db_roles)
{
    $frag_db_roles =   $mismatched_db_roles | Sort-Object database | select database, role, username, @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
    |  ConvertTo-Html -as Table -Fragment -PreContent $pre_rm | Out-String

}
write-host "Done!" -ForegroundColor Green

#endregion

#######################################################
#region <<<<<<<<<< Instance Role Members >>>>>>>>>>
#######################################################

write-host "Processing Instance Role Members..." -ForegroundColor yellow -NoNewline

$source_instance_role_members = Get-DbaServerRoleMember -SqlInstance $source
$target_instance_role_members = Get-DbaServerRoleMember -SqlInstance $target

$mismatched_instance_roles = Compare-Object $source_instance_role_members $target_instance_role_members -Property role, name

if ($mismatched_instance_roles)
{
    $frag_instance_roles =   $mismatched_instance_roles | Sort-Object role | select role, name, @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
    |  ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Mismatched Server Roles</font></b><br><br>"  | Out-String

}
write-host "Done!" -ForegroundColor Green


#endregion


############################################
#region <<<<<<<<<< Agent Jobs >>>>>>>>>>
############################################

    write-host "Processing Agent Jobs..." -ForegroundColor yellow -NoNewline

    $pre_js = 
    "<br><b><font color=green size=4>Job Step Mismatched</font></b><br>
    <font color=#2B3856 size=3>&nbsp;&nbsp;&nbsp The folling job steps are different between the two instances.</font><br><br>"
 


    $jobs_s = Get-DbaAgentJob $source | where {($_.category -notlike "*Automated*Backups") -and ($_.category -notlike "*Backup - Ready To Run")} | select name
    $jobs_t = Get-DbaAgentJob $target | where {($_.category -notlike "*Automated*Backups") -and ($_.category -notlike "*Backup - Ready To Run")} | select name

    $missing_jobs = Compare-Object $jobs_s $jobs_t -Property name

    $matching_jobs = Compare-Object $jobs_s $jobs_t -Property name -ExcludeDifferent -IncludeEqual

    if ($missing_jobs)
    {
        $frag_jobs =  $missing_jobs | select name,  @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
        |  where {$_.name -ne 'None'}  | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Missing SQL Jobs</font></b><br><br>" | Out-String

    }
        
    $sjs = Get-DbaAgentJobStep -SqlInstance $source
    $tjs = Get-DbaAgentJobStep -SqlInstance $target
    
    $source_jobsteps = ($sjs | where {$matching_jobs.name -contains $_.agentjob})
    $target_jobsteps = ($tjs | where {$matching_jobs.name -contains $_.agentjob})

    $mismatched_steps = (Compare-Object $source_jobsteps $target_jobsteps -Property agentjob, id, name, command) | select agentjob, id, name | sort-object -Property agentjob -Unique

    if ($mismatched_steps)
    {
        $frag_missingjobsteps =  $mismatched_steps`
        | select  @{n="Job Name"; e={$_.agentJob}},`
        @{n="Step ID"; e={$_.id}},`
        @{n="Step Name"; e={$_.name}}  | ConvertTo-Html -as Table -Fragment -PreContent $pre_js | Out-String

    }


    write-host "Done!" -ForegroundColor Green
#endregion

################################################
#region <<<<<<<<<< Orphaned Users >>>>>>>>>>
################################################

write-host "Processing Orphaned Users..." -ForegroundColor Yellow -NoNewline
<#
$pre_orph = @"
<br><b><font color=green size=4>Orphaned Users</font></b><br>
<font color=#2B3856 size=3>&nbsp;&nbsp;&nbsp;Database users with no corresponding Login</font><br><br>
"@


$soure_orphaned_users = Get-DbaOrphanUser $source | select databasename, user, @{n="Orphaned On";e={"Source"}}
$target_orphaned_users = Get-DbaOrphanUser $target | select databasename, user, @{n="Orphaned On";e={"Target"}}

$orphaned_users = $soure_orphaned_users + $target_orphaned_users

if ($orphaned_users)
{
    $frag_ou = $orphaned_users | ConvertTo-Html -as table -fragment -precontent $pre_orph | Out-String
}

#>

$sql_ou = "SELECT DB_NAME() as 'Database', p.name as 'User'
from sys.database_principals p
where p.type in ('G','S','U')
and p.sid not in (select sid from sys.server_principals)
and p.name not in (
    'dbo',
    'GUEST',
    'INFORMATION_SCHEMA',
    'sys',
    'MS_DataCollectorInternalUser'
)"


$source_orphans = foreach ($db in $source_databases)
{
    try
    {
        $u = Invoke-DbaQuery -SqlInstance $source -query $sql_ou -Database $db.name -EnableException
    }
    catch
    {
        $zz = $zz
    }
    $u
}

$target_orphans = foreach ($db in $target_databases)
{
    try
    {
        $u = Invoke-DbaQuery -SqlInstance $target -query $sql_ou -Database $db.name -EnableException
    }
    catch
    {
        $zz = $zz
    }
        $u
}


if ($source_orphans)
{
    $frag_so =  $source_orphans | select Database, User `
    | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Orphaned Users On source</font></b><br><br>" | Out-String

}

if ($target_orphans)
{
    $frag_to =  $target_orphans | select Database, User `
    | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Orphaned Users On Target</font></b><br><br>" | Out-String

}


write-host "Done!" -ForegroundColor Green


#endregion

################################################
#region <<<<<<<<<< Linked Servers >>>>>>>>>>
################################################

    write-host "Comparing Linked Servers... " -ForegroundColor Yellow -nonewline
    $ls_s = Get-DbaLinkedServer -SqlInstance $source | select name, RemoteServer, remoteuser
    if (!($ls_s))
    {
    $ls_s = New-Object system.object
    $ls_s | Add-Member -type NoteProperty -name "Name" -value  'None'
    $ls_s | Add-Member -type NoteProperty -name "RemoteServer" -value  'None'
    $ls_s | Add-Member -type NoteProperty -name "RemoteUser" -value  'None'
    }
   
    
    $ls_t = get-DbaLinkedServer -SqlInstance $target | select  name, RemoteServer, remoteuser
    if (!($ls_s))
    {
    $ls_s = New-Object system.object
    $ls_s | Add-Member -type NoteProperty -name "Name" -value  'None'
    $ls_s | Add-Member -type NoteProperty -name "RemoteServer" -value  'None'
    $ls_s | Add-Member -type NoteProperty -name "RemoteUser" -value  'None'
    }

    $missing_ls = Compare-Object $ls_s $ls_t -Property name, RemoteServer, remoteuser

    foreach($na in $missing_ls | where remoteuser -eq "")
    {
        $na.RemoteUser = 'N/A'
    }
    
    if ($missing_ls)
    {
        $frag_ls =  $missing_ls | select name, RemoteServer, remoteuser, @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
        |  where {$_.name -ne 'None' -and $_.remoteserver -ne 'None'} | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Unmatched LinkedServers</font></b><br><br>" | Out-String

    }
 write-host "Done!" -ForegroundColor Green

if ($test_linked_server -eq 1)    
    {
        write-host "Testing Linked Server Connectivity - (This may take a few minutes depending on the number of Linked Servers)... " -ForegroundColor Yellow -nonewline
        $ls_conn = Test-DbaLinkedServerConnection -SqlInstance $source | select @{n="Instance";expression={'Source'}}, LinkedServerName, RemoteServer, Connectivity    
        $ls_conn = $ls_conn + (Test-DbaLinkedServerConnection -SqlInstance $target | select @{n="Instance";expression={'Target'}}, LinkedServerName, RemoteServer, Connectivity)

        if ($ls_conn)
        {
            $frag_lsc_con =  $ls_conn | select instance, LinkedServerName, RemoteServer, Connectivity `
            | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>LinkedServer Connectivity Report</font></b><br><br>" | Out-String
        }
        write-host "Done!" -ForegroundColor Green
    }
#endregion

#####################################################
#region <<<<<<<<<< Availability Groups >>>>>>>>>>
#####################################################

    write-host "Processing Availability Groups..." -ForegroundColor Yellow -NoNewline
    $ao_s = Get-DbaAgreplica $source | select replica,availabilitygroup, availabilitymode, failovermode | where {$_.replica -eq $source -or $_.replica -eq $target}
    if (!($ao_s))
    {
    $ao_s = New-Object system.object
    $ao_s | Add-Member -type NoteProperty -name "replica" -value  'None'
    $ao_s | Add-Member -type NoteProperty -name "availabilitygroup" -value  'None'
    $ao_s | Add-Member -type NoteProperty -name "availabilitymode" -value  'None'
    $ao_s | Add-Member -type NoteProperty -name "failovermode" -value  'None'
    }

    $ao_t = Get-DbaAgreplica $target | select replica,availabilitygroup, availabilitymode, failovermode | where {$_.replica -eq $source -or $_.replica -eq $target}
    if (!($ao_t))
    {
    $ao_t = New-Object system.object
    $ao_t | Add-Member -type NoteProperty -name "replica" -value  'None'
    $ao_t | Add-Member -type NoteProperty -name "availabilitygroup" -value  'None'
    $ao_t | Add-Member -type NoteProperty -name "availabilitymode" -value  'None'
    $ao_t | Add-Member -type NoteProperty -name "failovermode" -value  'None'
    }

    $missing_ao = Compare-Object $ao_s $ao_t -Property replica,availabilitygroup, availabilitymode, failovermode

    if ($missing_ao)
    {
        write-host "not missing"
        $frag_ao =  $missing_ao | select availabilitygroup, availabilitymode, failovermode, @{n="Missing On";e={ if ($_.SideIndicator -eq '=>') { "Source" }  else { "Target" } }} `
        |  where {$_.replica -ne 'None' -and $_.availabilitygroup -ne 'None'} | ConvertTo-Html -as Table -Fragment -PreContent "<br><b><font color=green size=4>Unmatched Availability Groups</font></b><br><br>" | Out-String

    }
    write-host "Done!" -ForegroundColor Green

#endregion

###########################################################
#region <<<<<<<<<< Generate and format email >>>>>>>>>>
###########################################################

$html = 
@"
    <table style="display: inline-block; border: 1px solid black;" >
        <tr>
            <td style="color=black; background-color:honeydew;"><strong>Source Server : </strong></td>
            <td style="color=black; background-color:honeydew;">$s_instance</font></td>
        </tr>
         <tr>
            <td>Build No : </td>
            <td><font color=green>$s_build</font></td>
        </tr>
        <tr>
            <td>Physical CPU</td>
            <td><font color=green>$s_pprocs</font></td>
        </tr>
        <tr>
            <td>Logical CPU</td>
            <td><font color=green>$s_lprocs</font></td>
        </tr>
        <tr>
            <td>Total Memory</td>
            <td><font color=green>$s_ram</font></td>
        </tr>
        <tr>
            <td>MaxDop</td>
            <td><font color=green>$s_mdop</font></td>
        </tr>
        <tr>
            <td>Cost Threshold for MaxDop</td>
            <td><font color=green>$s_cdop</font></td>
        </tr>
    </table>
 <table style="display: inline-block; border: 1px solid black;" >
        <tr>
            <td style="color=black; background-color:mistyrose;"><strong>Target Server : </strong></td>
            <td style="color=black; background-color:mistyrose;">$t_instance</font></td>
        </tr>
         <tr>
            <td>Build No</td>
            <td><font color=green>$t_build</font></td>
        </tr>
        <tr>
            <td>Physical CPU</td>
            <td><font color=green>$t_pprocs</font></td>
        </tr>
         <tr>
            <td>Logical CPU</td>
             <td><font color=green>$t_lprocs</font></td>
        <tr>
            <td>Total Memory</td>
            <td><font color=green>$t_ram</font></td>
        <tr>
            <td>MaxDop</td>
            <td><font color=green>$t_mdop</font></td>
        </tr>
        <tr>
            <td>Cost Threshold for MaxDop</td>
            <td><font color=green>$t_cdop</font></td>
        </tr
        </tr>
    </table>
<br>
<br>
"@


$header = @"
<hr>
<b><u><font color=Black size=5>Instance Comparison</font></b></u><br>
<br>
<b><font color=Black size=3>Source Server &nbsp;: </font><font color=Green>$Source</font></b><br>
<b><font color=Black size=3>Target Server &nbsp;: </font><font color=Green>$Target</font></b>
<br>
<b><font color=Black size=3>Compare Date : </font><font color=Green>$Compare_date</font></b>
<br>
<br><b><font color=Black size=3>Generated By &nbsp;: </font><font color=Green>$ran_by</font></b>
<br><hr>
<br>
<b>Notes :</b>
<br><br>
This output has been generated by comparing the following.<br><br>
<b>1.</b>     Instance startup parameters<br>
<b>2.</b>     Missing Databases (if the option is selected)<br>
<b>3.</b>     TempDB Configuration inc missing files<br>
<b>4.</b>     Missing Logins<br>
<b>5.</b>     Orphaned Users<br>
<b>6.</b>     Missing database roles and mismatched members (only for matching databases)<br>
<b>7.</b>     Missing SQL Jobs<br>
<b>8.</b>     Linked Servers (Connectivity can also be tested)<br>
<b>9.</b>     Availabilty Group configuration<br>
<b>10.</b>    Missing mail profiles<br>
<b>11.</b>    Mismatched public \ default mail profiles<br>
<b>12.</b>    Mismatched Server Role Members<br>
<b>13.</b>    Mismatched Volume Capacity<br>

<br><br>
If any of these categories are missing, then there are no differences

Also, ENSURE to check the build number and hardware config at the top of the report.
<br> 
<hr>
<br>
"@

$head = @"
<style>
TD{font-family: Arial; font-size: 8pt;}
TABLE {border-width: 1px; border-style: solid; border-color: black; border-collapse: collapse;}
TH {border-width: 1px; padding: 3px; border-style: solid; border-color: black; background-color: #6495ED;}
TD {border-width: 1px; padding: 3px; border-style: solid; border-color: black;}
</style>
"@

$head = @"
<style>
TD{font-family: Arial; font-size: 8pt;}
TABLE {border-width: 1px; border-style: solid; border-color: black; border-collapse: collapse;}
TH {border-width: 1px; padding: 3px; border-style: solid; border-color: black; background-color: white;}
TD {border-width: 1px; padding: 3px; border-style: solid; border-color: black;}
</style>
"@

$test = @"
This output has been generated by comparing the following.<br><br>
"@


[string]$output =   $header + $html + `
                    $frag_config + `   # - Instance configuration differences
                    $frag_volumes + `  # - Mismatched Volumes
                    $frag_su + `       # - Mismatched startup parameters
                    $frag_udbs + `     # - Missing Databases
                    $frag_tempdb + `   # - TempDB configuration
                    $frag_tempdb_s + ` # - TempDB missing on source
                    $frag_tempdb_t + ` # - TempDB missing on target
                    $frag_logins + `   # - Missing Logins
                    $frag_instance_roles + ` # - Mismatched Instance Role members
                    $frag_so + `       # - Orphaned Users
                    $frag_to + `       # - Orphaned Users
                    $frag_db_roles + ` # - Missing Roles or role members
                    $frag_jobs + `     # - Missing SQL Jobs
                    $frag_missingjobsteps + ` # Mismatched job steps
                    $frag_ls + `       # - Missing linked servers
                    $frag_lsc_con + `  # - Linked servers connectivity test
                    $frag_ao + `       # - AlwaysOn Configuration differences
                    $frag_mp           # - Missing Mail Profiles


$output = $output -replace("<td>source</td>", "<td style='background-color:honeydew'>$source</td>")
$output = $output -replace("<td>target</td>", "<td style='background-color:mistyrose'>$target</td>")

ConvertTo-HTML -head $head -PostContent $output | Out-File $output_file
write-host ""
write-host "Compare Complete.! The results can be found here $output_file" -ForegroundColor Green
Start-Process $output_file


#endregion
